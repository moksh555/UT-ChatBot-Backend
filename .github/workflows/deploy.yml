name: Deploy to EC2 (SSH)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build, tag and push image to ECR (latest)
        run: |
          IMAGE="${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}"
          docker build -t "$IMAGE:latest" .
          docker push "$IMAGE:latest"

      - name: Decode SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" | base64 --decode > key.pem
          chmod 600 key.pem

      - name: Deploy on EC2 via SSH
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e

            echo "Logging into ECR..."
            aws ecr get-login-password --region us-east-1 \
              | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}

            echo "Pulling latest image..."
            docker pull ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:latest

            echo "Stopping old container (if any)..."
            docker stop texas-chatbot 2>/dev/null || true
            docker rm texas-chatbot 2>/dev/null || true

            echo "Freeing port 8000 (if needed)..."
            CONTAINER_ON_8000=$(docker ps -q --filter "publish=8000")
            if [ -n "$CONTAINER_ON_8000" ]; then
              echo "Stopping containers using port 8000: $CONTAINER_ON_8000"
              docker stop $CONTAINER_ON_8000 || true
              docker rm $CONTAINER_ON_8000 || true
            fi

            echo "Starting new container..."
            docker run -d \
              --name texas-chatbot \
              --restart=always \
              -p 8000:8000 \
              --env-file /home/ec2-user/.env \
              ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:latest

            echo "Container status:"
            docker ps --filter name=texas-chatbot

            echo "Health check:"
            curl -sS http://localhost:8000/health || true

            echo "Done."
          EOF
